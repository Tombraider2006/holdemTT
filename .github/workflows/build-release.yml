name: Build Release APK

on:
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: v0.2)'
        required: true
        default: 'v0.2'
      release_notes:
        description: '–ó–∞–º–µ—Ç–∫–∏ –∫ —Ä–µ–ª–∏–∑—É'
        required: false
        default: '–†–µ–ª–∏–∑ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: platform-tools platforms;android-35 build-tools;35.0.0
        accept-android-sdk-licenses: true
      
    - name: Accept Android SDK Licenses
      run: |
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        echo "8403addf88ab4874007e1c1e80a0025bf2550a37" > $ANDROID_HOME/licenses/android-googletv-license
        echo "601085b94cd77f0b54ff864069570109382c4e6f" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/intel-android-extra-license
        echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/google-gdk-license
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      
    - name: Setup Gradle Wrapper
      run: |
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
          echo "Downloading gradle-wrapper.jar..."
          mkdir -p gradle/wrapper
          curl -L -f -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar
        fi
        chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
      
    - name: Build release APK
      run: ./gradlew clean assembleRelease --no-daemon --stacktrace
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        JAVA_HOME: ${{ env.JAVA_HOME }}
      
    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: Release ${{ github.event.inputs.version }}
        body: |
          ## –¢–µ—Ö–∞—Å—Å–∫–∏–π –•–æ–ª–¥–µ–º –¥–ª—è Android ${{ github.event.inputs.version }}
          
          ${{ github.event.inputs.release_notes }}
          
          ### üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
          - –û–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—Å–∏–π (AGP 8.7.3, Kotlin 2.1.10, Compose BOM 2024.12.01)
          - –í–Ω–µ–¥—Ä–µ–Ω UiState –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
          - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è WhileUiSubscribed –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
          - –°–æ–∑–¥–∞–Ω Repository —Å–ª–æ–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
          - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
          
          ### üì± –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
          - –ü–æ–ª–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ç–µ—Ö–∞—Å—Å–∫–æ–≥–æ —Ö–æ–ª–¥–µ–º–∞
          - –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Å—Ç–∞–≤–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ GTO —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (2025)
          - –ê–Ω–∞–ª–∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —Ä—É–∫ –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤ (solver-based –∞–ª–≥–æ—Ä–∏—Ç–º—ã)
          - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI –Ω–∞ Jetpack Compose
          - –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (UTF-8)
          
          ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ APK –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ Assets –Ω–∏–∂–µ
          2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Android
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ APK —Ñ–∞–π–ª
        files: |
          app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

